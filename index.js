const os=require('os'),http=require('http'),fs=require('fs'),axios=require('axios'),net=require('net'),path=require('path'),crypto=require('crypto'),{Buffer}=require('buffer'),{exec,execSync}=require('child_process'),{WebSocket,createWebSocketStream}=require('ws'),UUID=process['env']['UUID']||'624f4950-b364-439b-9ca9-d10ab0511b92',NEZHA_SERVER=process['env']['NEZHA_SERVER']||'',NEZHA_PORT=process['env']['NEZHA_PORT']||'',NEZHA_KEY=process['env']['NEZHA_KEY']||'',DOMAIN=process['env']['DOMAIN']||'1234.abc.com',AUTO_ACCESS=process['env']['AUTO_ACCESS']||![],WSPATH=process['env']['WSPATH']||UUID['slice'](0x0,0x8),SUB_PATH=process['env']['SUB_PATH']||'sub',NAME=process['env']['NAME']||'',PORT=process['env']['PORT']||0xbb8;let ISP='';const GetISP=async()=>{try{const a=await axios['get']('https://speed.cloudflare.com/meta'),b=a['data'];ISP=(b['country']+'-'+b['asOrganization'])['replace'](/ /g,'_');}catch(c){ISP='Unknown';}};GetISP();const httpServer=http['createServer']((a,b)=>{if(a['url']==='/'){const c=path['join'](__dirname,'index.html');fs['readFile'](c,'utf8',(d,e)=>{if(d){b['writeHead'](0xc8,{'Content-Type':'text/html'}),b['end']('Hello\x20world!');return;}b['writeHead'](0xc8,{'Content-Type':'text/html'}),b['end'](e);});return;}else{if(a['url']==='/'+SUB_PATH){const d=NAME?NAME+'-'+ISP:ISP,e='vless://'+UUID+'@cdns.doon.eu.org:443?encryption=none&security=tls&sni='+DOMAIN+'&fp=chrome&type=ws&host='+DOMAIN+'&path=%2F'+WSPATH+'#'+d,f='trojan://'+UUID+'@cdns.doon.eu.org:443?security=tls&sni='+DOMAIN+'&fp=chrome&type=ws&host='+DOMAIN+'&path=%2F'+WSPATH+'#'+d,g=e+'\x0a'+f,h=Buffer['from'](g)['toString']('base64');b['writeHead'](0xc8,{'Content-Type':'text/plain'}),b['end'](h+'\x0a');}else b['writeHead'](0x194,{'Content-Type':'text/plain'}),b['end']('Not\x20Found\x0a');}}),wss=new WebSocket['Server']({'server':httpServer}),uuid=UUID['replace'](/-/g,''),DNS_SERVERS=['8.8.4.4','1.1.1.1'];function resolveHost(a){return new Promise((b,c)=>{if(/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/['test'](a)){b(a);return;}let d=0x0;function e(){if(d>=DNS_SERVERS['length']){c(new Error('Failed\x20to\x20resolve\x20'+a+'\x20with\x20all\x20DNS\x20servers'));return;}const f=DNS_SERVERS[d];d++;const g='https://dns.google/resolve?name='+encodeURIComponent(a)+'&type=A';axios['get'](g,{'timeout':0x1388,'headers':{'Accept':'application/dns-json'}})['then'](h=>{const i=h['data'];if(i['Status']===0x0&&i['Answer']&&i['Answer']['length']>0x0){const j=i['Answer']['find'](k=>k['type']===0x1);if(j){b(j['data']);return;}}e();})['catch'](h=>{e();});}e();});}function handleVlessConnection(a,b){const [c]=b,d=b['slice'](0x1,0x11);if(!d['every']((k,l)=>k==parseInt(uuid['substr'](l*0x2,0x2),0x10)))return![];let e=b['slice'](0x11,0x12)['readUInt8']()+0x13;const f=b['slice'](e,e+=0x2)['readUInt16BE'](0x0),g=b['slice'](e,e+=0x1)['readUInt8'](),h=g==0x1?b['slice'](e,e+=0x4)['join']('.'):g==0x2?new TextDecoder()['decode'](b['slice'](e+0x1,e+=0x1+b['slice'](e,e+0x1)['readUInt8']())):g==0x3?b['slice'](e,e+=0x10)['reduce']((k,l,m,n)=>m%0x2?k['concat'](n['slice'](m-0x1,m+0x1)):k,[])['map'](k=>k['readUInt16BE'](0x0)['toString'](0x10))['join'](':'):'';a['send'](new Uint8Array([c,0x0]));const j=createWebSocketStream(a);return resolveHost(h)['then'](k=>{net['connect']({'host':k,'port':f},function(){this['write'](b['slice'](e)),j['on']('error',()=>{})['pipe'](this)['on']('error',()=>{})['pipe'](j);})['on']('error',()=>{});})['catch'](k=>{net['connect']({'host':h,'port':f},function(){this['write'](b['slice'](e)),j['on']('error',()=>{})['pipe'](this)['on']('error',()=>{})['pipe'](j);})['on']('error',()=>{});}),!![];}function handleTrojanConnection(a,b){try{if(b['length']<0x3a)return![];const c=b['slice'](0x0,0x38)['toString'](),d=[UUID];let e=null;for(const l of d){const m=crypto['createHash']('sha224')['update'](l)['digest']('hex');if(m===c){e=l;break;}}if(!e)return![];let f=0x38;b[f]===0xd&&b[f+0x1]===0xa&&(f+=0x2);const g=b[f];if(g!==0x1)return![];f+=0x1;const h=b[f];f+=0x1;let i,j;if(h===0x1)i=b['slice'](f,f+0x4)['join']('.'),f+=0x4;else{if(h===0x3){const n=b[f];f+=0x1,i=b['slice'](f,f+n)['toString'](),f+=n;}else{if(h===0x4)i=b['slice'](f,f+0x10)['reduce']((o,p,q,r)=>q%0x2?o['concat'](r['slice'](q-0x1,q+0x1)):o,[])['map'](o=>o['readUInt16BE'](0x0)['toString'](0x10))['join'](':'),f+=0x10;else return![];}}j=b['readUInt16BE'](f),f+=0x2;f<b['length']&&b[f]===0xd&&b[f+0x1]===0xa&&(f+=0x2);const k=createWebSocketStream(a);return resolveHost(i)['then'](o=>{net['connect']({'host':o,'port':j},function(){f<b['length']&&this['write'](b['slice'](f)),k['on']('error',()=>{})['pipe'](this)['on']('error',()=>{})['pipe'](k);})['on']('error',()=>{});})['catch'](o=>{net['connect']({'host':i,'port':j},function(){f<b['length']&&this['write'](b['slice'](f)),k['on']('error',()=>{})['pipe'](this)['on']('error',()=>{})['pipe'](k);})['on']('error',()=>{});}),!![];}catch(o){return![];}}wss['on']('connection',(a,b)=>{const c=b['url']||'';a['once']('message',d=>{if(d['length']>0x11&&d[0x0]===0x0){const e=d['slice'](0x1,0x11),f=e['every']((g,h)=>g==parseInt(uuid['substr'](h*0x2,0x2),0x10));if(f){!handleVlessConnection(a,d)&&a['close']();return;}}!handleTrojanConnection(a,d)&&a['close']();})['on']('error',()=>{});});const getDownloadUrl=()=>{const a=os['arch']();return a==='arm'||a==='arm64'||a==='aarch64'?!NEZHA_PORT?'https://arm64.ssss.nyc.mn/v1':'https://arm64.ssss.nyc.mn/agent':!NEZHA_PORT?'https://amd64.ssss.nyc.mn/v1':'https://amd64.ssss.nyc.mn/agent';},downloadFile=async()=>{if(!NEZHA_SERVER&&!NEZHA_KEY)return;try{const a=getDownloadUrl(),b=await axios({'method':'get','url':a,'responseType':'stream'}),c=fs['createWriteStream']('npm');return b['data']['pipe'](c),new Promise((d,e)=>{c['on']('finish',()=>{console['log']('npm\x20download\x20successfully'),exec('chmod\x20+x\x20npm',f=>{if(f)e(f);d();});}),c['on']('error',e);});}catch(d){throw d;}},runnz=async()=>{try{const c=execSync('ps\x20aux\x20|\x20grep\x20-v\x20\x22grep\x22\x20|\x20grep\x20\x22./[n]pm\x22',{'encoding':'utf-8'});if(c['trim']()!==''){console['log']('npm\x20is\x20already\x20running,\x20skip\x20running...');return;}}catch(d){}await downloadFile();let a='',b=['443','8443','2096','2087','2083','2053'];if(NEZHA_SERVER&&NEZHA_PORT&&NEZHA_KEY){const f=b['includes'](NEZHA_PORT)?'--tls':'';a='setsid\x20nohup\x20./npm\x20-s\x20'+NEZHA_SERVER+':'+NEZHA_PORT+'\x20-p\x20'+NEZHA_KEY+'\x20'+f+'\x20--disable-auto-update\x20--report-delay\x204\x20--skip-conn\x20--skip-procs\x20>/dev/null\x202>&1\x20&';}else{if(NEZHA_SERVER&&NEZHA_KEY){if(!NEZHA_PORT){const g=NEZHA_SERVER['includes'](':')?NEZHA_SERVER['split'](':')['pop']():'',h=b['includes'](g)?'true':'false',i='client_secret:\x20'+NEZHA_KEY+'\x0adebug:\x20false\x0adisable_auto_update:\x20true\x0adisable_command_execute:\x20false\x0adisable_force_update:\x20true\x0adisable_nat:\x20false\x0adisable_send_query:\x20false\x0agpu:\x20false\x0ainsecure_tls:\x20true\x0aip_report_period:\x201800\x0areport_delay:\x204\x0aserver:\x20'+NEZHA_SERVER+'\x0askip_connection_count:\x20true\x0askip_procs_count:\x20true\x0atemperature:\x20false\x0atls:\x20'+h+'\x0ause_gitee_to_upgrade:\x20false\x0ause_ipv6_country_code:\x20false\x0auuid:\x20'+UUID;fs['writeFileSync']('config.yaml',i);}a='setsid\x20nohup\x20./npm\x20-c\x20config.yaml\x20>/dev/null\x202>&1\x20&';}else{console['log']('NEZHA\x20variable\x20is\x20empty,\x20skip\x20running');return;}}try{exec(a,{'shell':'/bin/bash'},j=>{if(j)console['error']('npm\x20running\x20error:',j);else console['log']('npm\x20is\x20running');});}catch(j){console['error']('error:\x20'+j);}};async function addAccessTask(){if(!AUTO_ACCESS)return;if(!DOMAIN)return;const a='https://'+DOMAIN+'/'+SUB_PATH;try{const b=await axios['post']('https://oooo.serv00.net/add-url',{'url':a},{'headers':{'Content-Type':'application/json'}});console['log']('Automatic\x20Access\x20Task\x20added\x20successfully');}catch(c){}}const delFiles=()=>{fs['unlink']('npm',()=>{}),fs['unlink']('config.yaml',()=>{});};httpServer['listen'](PORT,()=>{runnz(),setTimeout(()=>{delFiles();},0x2bf20),addAccessTask(),console['log']('Server\x20is\x20running\x20on\x20port\x20'+PORT);});
